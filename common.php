<?// common.php - functions often needed across pages in this domain.function conn() {// Open a database connection.	@ $db = mysql_pconnect("mysql.parkermorse.net", "pjmorse", "zakriv");	if (!$db) {		echo "Error: Could not connect to database. Please try again.";		exit;	}	mysql_select_db("pub_clips");}function head() {// Somewhat mis-named: writes the first part of the body of a page.	echo "  <p class=\"siteAbout\"><a href=\"/home.html\">back home</a></p>\r";}function tail() {// Closes out any tags opened in head() and prepares the page for the// concluding </body></html>.	echo "<p><a href=\"/about.html\">about this site</a> </p>\r";}function verify_pw($given, $stored) {// True or false: did they give the right password?	$salt = substr($stored, 0, CRYPT_SALT_LENGTH);	$given_encrypted = crypt($given, $salt);	return ($stored == $given_encrypted);}function authenticate($perms) {// Does the whole check for a given page.  switch($perms) {  	case "admin":  		$realm = "Parker Admin";  		break;  	default:  		$realm = $perms;  }  if(!IsSet($_SERVER['PHP_AUTH_USER'])) {    Header("WWW-Authenticate: Basic realm=\"$realm\"");    Header("HTTP/1.0 401 Unauthorized");    echo "Canceled by user\n";    exit;  } else {    $curr_user = $_SERVER['PHP_AUTH_USER'];    $given = $_SERVER['PHP_AUTH_PW'];    $pass_set = mysql_query("select * from users where login = '$curr_user'");    $pass_row = mysql_fetch_array($pass_set);    $stored = $pass_row['password'];    $admin = $pass_row['admin'];    if (($perms == 'drs') || (($perms == 'admin') && ($admin == 'Y'))) {    	$access_ok = 1;    }    if ((verify_pw($given, $stored)) && ($access_ok)) {      return(1);    } else {      echo "<html><head><title>failed</title><link rel=\"stylesheet\" href=\"styles1.css\"></head><body>\r";      head("failed");      echo "<h3>Authentication failed.</h3>\r";      echo "<p>admin: $admin<br>\r";      echo "access: $access_ok<br>\r";      echo "perms: $perms<br>\r";      echo "pw: - ";      echo verify_pw($given, $stored);      echo "<br>\r";//     echo CRYPT_SALT_LENGTH;      echo $stored;      echo "<br>\r";	$salt = substr($stored, 0, CRYPT_SALT_LENGTH);	$given_encrypted = crypt($given, $salt);      echo $given_encrypted;      echo "</p>\r";      echo "</body></html>\r";      exit;    }  }}function new_pw($given) {// Generates an encrypted password for the database.	return crypt($given);}function race_form($race) {// A form for adding or editing races to the race database.// Given a $race index, will populate the form with data from the table.// Assumes the "<form>" tags are already in place!	if ($race) {		$race_q = mysql_query("select * from races where race_id = $race");		$race_r = mysql_fetch_array($race_q);		$date = $race_r['date'];		$name = $race_r['name'];		$city = $race_r['city'];		$state = $race_r['state'];		$distance = $race_r['distance'];		$unit = $race_r['unit'];		$time = $race_r['time'];		$place = $race_r['place'];		$agplace = $race_r['agplace'];		$link = $race_r['link'];		$surface = $race_r['surface'];		$report = $race_r['report'];		list($year, $month, $day) = explode("-", $date);	}	echo "<p>\r";	echo "Year:";	echo "<select name=\"year\">\r";	$thisyear = date(Y);	if (!$year) {		$year = $thisyear;	}	for($i=1986;$i<=$thisyear;$i++) {		echo "<option";		if ($year == $i) {			echo " selected";		}		echo ">$i</option>\r";	}	echo "</select>\r</p>\r";	echo "<p>\rMonth:\r";	echo "<select name=\"month\">\r";	echo "<option value=\"01\"";	if ($month == '01') {		echo " selected";	}	echo ">January</option>\r";	echo "<option value=\"02\"";	if ($month == '02') {		echo " selected";	}	echo ">February</option>\r";	echo "<option value=\"03\"";	if ($month == '03') {		echo " selected";	}	echo ">March</option>\r";	echo "<option value=\"04\"";	if ($month == '04') {		echo " selected";	}	echo ">April</option>\r";	echo "<option value=\"05\"";	if ($month == '05') {		echo " selected";	}	echo ">May</option>\r";	echo "<option value=\"06\"";	if ($month == '06') {		echo " selected";	}	echo ">June</option>\r";	echo "<option value=\"07\"";	if ($month == '07') {		echo " selected";	}	echo ">July</option>\r";	echo "<option value=\"08\"";	if ($month == '08') {		echo " selected";	}	echo ">August</option>\r";	echo "<option value=\"09\"";	if ($month == '09') {		echo " selected";	}	echo ">September</option>\r";	echo "<option value=\"10\"";	if ($month == '10') {		echo " selected";	}	echo ">October</option>\r";	echo "<option value=\"11\"";	if ($month == '11') {		echo " selected";	}	echo ">November</option>\r";	echo "<option value=\"12\"";	if ($month == '12') {		echo " selected";	}	echo ">December</option>\r";	echo "</select>\r</p>\r";	echo "<p>\rDay:\r";	echo "<input name=\"day\" value=\"$day\" size=\"3\" maxlength=\"2\">\r</p>\r";	echo "<p>Race Name:";	echo "<input name=\"name\" value=\"$name\" size=\"60\">\r</p>\r";	echo "<p>City, State:";	echo "<input name=\"city\" value=\"$city\" size=\"60\">\r";	echo "<input name=\"state\" value=\"$state\" size=\"3\" maxlength=\"2\">\r</p>\r";	echo "<p>Distance:";	echo "<input name=\"distance\" value=\"$distance\" size=\"5\" maxlength=\"5\">\r";	echo "<select name=\"unit\">\r";	echo "<option value=\"km\"";	if ($unit == 'km') {		echo " selected";	}	echo ">km</option>\r";	echo "<option value=\"m\"";	if ($unit == 'm') {		echo " selected";	}	echo ">m</option>\r";	echo "<option value=\"Mi.\"";	if ($unit == 'Mi.') {		echo " selected";	}	echo ">Mi.</option>\r";	echo "</select>\r</p>\r";	echo "<p>Time:\r";	echo "<input name=\"time\" value=\"$time\" size=\"9\" maxlength=\"8\">\r</p>\r";	echo "<p>Place:\r";	echo "<input name=\"place\" value=\"$place\" size=\"5\" maxlength=\"4\">\r</p>\r";	echo "<p>Age Group Place:\r";	echo "<input name=\"agplace\" value=\"$agplace\" size=\"5\" maxlength=\"4\">\r</p>\r";	echo "<p>Race URL:\r";	echo "<input name=\"link\" value=\"$link\" size=\"60\">\r</p>\r";	echo "<p>Surface:\r";	echo "<select name=\"surface\">\r";	echo "<option";	if ($surface == 'Road') {		echo " selected";	}	echo ">Road</option>\r";	echo "<option";	if ($surface == 'Track') {		echo " selected";	}	echo ">Track</option>\r";	echo "<option";	if ($surface == 'Cross') {		echo " selected";	}	echo ">Cross</option>\r";	echo "</select>\r</p>\r";	echo "<p>Report:\r";	echo "<input name=\"report\" value=\"$report\" size=\"60\">\r</p>\r";	echo "<p><input type=\"submit\"></p>\r";}?>